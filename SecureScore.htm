<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Microsoft Secure Score â€” Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet"/>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:          #070c14;
  --bg2:         #0a1120;
  --surface:     #0d1625;
  --surface2:    #111e30;
  --surface3:    #16253a;
  --border:      rgba(255,255,255,0.07);
  --border2:     rgba(255,255,255,0.12);
  --blue:        #0078D4;
  --blue2:       #2899f5;
  --blue3:       rgba(0,120,212,0.15);
  --green:       #10b981;
  --green2:      rgba(16,185,129,0.15);
  --amber:       #f59e0b;
  --amber2:      rgba(245,158,11,0.15);
  --red:         #ef4444;
  --red2:        rgba(239,68,68,0.15);
  --purple:      #818cf8;
  --purple2:     rgba(129,140,248,0.15);
  --slate:       #64748b;
  --text:        #e2e8f4;
  --text2:       #94a3b8;
  --text3:       #4b5d78;
  --r:           12px;
  --r2:          8px;
}

[data-theme="light"] {
  --bg:      #f0f4fa;
  --bg2:     #e4ecf5;
  --surface: #ffffff;
  --surface2:#f7f9fc;
  --surface3:#edf2f9;
  --border:  rgba(0,0,0,0.07);
  --border2: rgba(0,0,0,0.12);
  --blue:    #0069c0;
  --blue2:   #0078D4;
  --blue3:   rgba(0,120,212,0.08);
  --green2:  rgba(16,185,129,0.1);
  --amber2:  rgba(245,158,11,0.1);
  --red2:    rgba(239,68,68,0.1);
  --purple2: rgba(129,140,248,0.1);
  --text:    #0f172a;
  --text2:   #475569;
  --text3:   #94a3b8;
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

body{
  font-family:'DM Sans',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  font-size:14px;
  line-height:1.5;
  overflow-x:hidden;
}

/* Background grid */
body::before{
  content:'';position:fixed;inset:0;
  background-image:
    linear-gradient(var(--border) 1px,transparent 1px),
    linear-gradient(90deg,var(--border) 1px,transparent 1px);
  background-size:40px 40px;
  pointer-events:none;z-index:0;
}

.page{
  position:relative;z-index:1;
  max-width:1340px;margin:0 auto;
  padding:0 24px 60px;
}

/* â”€â”€â”€ TYPOGRAPHY â”€â”€â”€ */
.font-display{font-family:'Syne',sans-serif}

/* â”€â”€â”€ SCROLLBAR â”€â”€â”€ */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:3px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOP NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.topnav{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 0 24px;gap:12px;flex-wrap:wrap;
  border-bottom:1px solid var(--border);margin-bottom:28px;
}
.nav-brand{display:flex;align-items:center;gap:14px}
.ms-logo{display:grid;grid-template-columns:1fr 1fr;gap:3px;width:32px;height:32px;flex-shrink:0}
.ms-logo span{border-radius:2px}
.ms-logo span:nth-child(1){background:#f25022}
.ms-logo span:nth-child(2){background:#7fba00}
.ms-logo span:nth-child(3){background:#00a4ef}
.ms-logo span:nth-child(4){background:#ffb900}
.nav-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;letter-spacing:-0.2px}
.nav-sub{font-size:11px;color:var(--text2);margin-top:1px}
.nav-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.sync-badge{
  display:flex;align-items:center;gap:7px;
  padding:6px 12px;border-radius:var(--r2);
  border:1px solid var(--border2);
  background:var(--surface);
  font-size:11px;color:var(--text2);
}
.sync-dot{width:7px;height:7px;border-radius:50%;background:var(--green);flex-shrink:0;box-shadow:0 0 6px var(--green)}
.sync-dot.inactive{background:var(--text3);box-shadow:none}
.btn{
  display:inline-flex;align-items:center;gap:7px;
  padding:7px 14px;border-radius:var(--r2);
  border:1px solid var(--border2);
  background:var(--surface);
  color:var(--text);font-family:'DM Sans',sans-serif;
  font-size:12px;cursor:pointer;transition:all .18s;
  white-space:nowrap;
}
.btn:hover{border-color:var(--blue);color:var(--blue2)}
.btn:disabled{opacity:.4;cursor:default;pointer-events:none}
.btn-primary{background:var(--blue);border-color:var(--blue);color:#fff}
.btn-primary:hover{background:var(--blue2);border-color:var(--blue2);color:#fff}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPLOAD ZONE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#uploadZone{
  border:2px dashed var(--border2);
  border-radius:var(--r);
  padding:48px 32px;
  text-align:center;
  cursor:pointer;
  transition:all .2s;
  margin-bottom:28px;
  background:var(--surface);
  position:relative;
  overflow:hidden;
}
#uploadZone::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(circle at 50% 0%,rgba(0,120,212,0.06),transparent 70%);
  pointer-events:none;
}
#uploadZone:hover,#uploadZone.drag-over{
  border-color:var(--blue);
  background:var(--surface2);
}
#uploadZone.drag-over{border-color:var(--blue2);background:var(--blue3)}
.upload-icon{font-size:40px;margin-bottom:14px;display:block}
.upload-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:6px}
.upload-sub{font-size:13px;color:var(--text2);margin-bottom:16px}
.upload-formats{
  display:inline-flex;gap:8px;flex-wrap:wrap;justify-content:center;
}
.fmt-badge{
  padding:3px 10px;border-radius:100px;
  border:1px solid var(--border2);
  font-size:11px;color:var(--text2);background:var(--surface3);
}
#uploadZone input[type="file"]{
  position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;
}
#uploadZone.has-data{
  padding:16px 24px;
  display:flex;align-items:center;gap:16px;justify-content:space-between;
  flex-wrap:wrap;
}
.upload-loaded{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.upload-file-icon{font-size:24px}
.upload-file-name{font-family:'Syne',sans-serif;font-weight:700;font-size:14px}
.upload-file-meta{font-size:12px;color:var(--text2)}
.upload-cta{font-size:12px;color:var(--blue2);cursor:pointer;z-index:2;position:relative;pointer-events:all}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD (hidden until data loads)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#dashboard{display:none}
#dashboard.visible{display:block}

/* â”€â”€â”€ SCORE HERO â”€â”€â”€ */
.score-hero{
  display:grid;
  grid-template-columns:220px 1fr;
  gap:0;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--r);
  margin-bottom:20px;
  overflow:hidden;
  position:relative;
}
.score-hero::before{
  content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--blue),var(--blue2),var(--purple));
}
.hero-gauge-side{
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:32px 24px;gap:10px;
  background:linear-gradient(135deg,var(--surface),var(--surface2));
}
.gauge-wrap{position:relative;width:160px;height:160px}
.gauge-wrap svg{width:160px;height:160px;transform:rotate(-90deg)}
.gauge-track{fill:none;stroke:var(--surface3);stroke-width:14}
.gauge-fill{
  fill:none;stroke:url(#heroGrad);stroke-width:14;
  stroke-linecap:round;
  stroke-dasharray:439;stroke-dashoffset:439;
  transition:stroke-dashoffset 1.8s cubic-bezier(.16,1,.3,1);
}
.gauge-center{
  position:absolute;inset:0;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
}
.gauge-pct{font-family:'Syne',sans-serif;font-size:34px;font-weight:800;line-height:1}
.gauge-of{font-size:11px;color:var(--text2);margin-top:3px}
.hero-posture-chip{
  display:inline-flex;align-items:center;gap:6px;
  padding:5px 12px;border-radius:100px;
  font-size:12px;font-weight:500;
  border:1px solid;
}
.posture-strong{background:var(--green2);border-color:rgba(16,185,129,.4);color:var(--green)}
.posture-moderate{background:var(--amber2);border-color:rgba(245,158,11,.4);color:var(--amber)}
.posture-risk{background:var(--red2);border-color:rgba(239,68,68,.4);color:var(--red)}

.hero-content{padding:28px 32px;display:flex;flex-direction:column;justify-content:center;gap:18px}
.hero-heading{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;line-height:1.2}
.hero-heading span{color:var(--blue2)}
.hero-body{font-size:13px;color:var(--text2);line-height:1.7;max-width:540px}
.hero-metrics{display:flex;gap:28px;flex-wrap:wrap}
.hero-metric{}
.hero-metric .val{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;line-height:1}
.hero-metric .lbl{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:.6px;margin-top:2px}

/* â”€â”€â”€ KPI GRID â”€â”€â”€ */
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:14px;
  margin-bottom:20px;
}
.kpi{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:20px;
  position:relative;overflow:hidden;
  transition:border-color .2s,transform .2s;
  cursor:default;
}
.kpi:hover{border-color:rgba(0,120,212,.4);transform:translateY(-2px)}
.kpi-top-bar{position:absolute;top:0;left:0;right:0;height:3px;border-radius:12px 12px 0 0}
.kpi-emoji{font-size:20px;margin-bottom:12px;display:block}
.kpi-val{font-family:'Syne',sans-serif;font-size:30px;font-weight:800;line-height:1;margin-bottom:4px}
.kpi-lbl{font-size:11px;text-transform:uppercase;letter-spacing:.6px;color:var(--text2);margin-bottom:4px}
.kpi-note{font-size:11px;color:var(--text3)}

/* â”€â”€â”€ CHARTS GRID â”€â”€â”€ */
.charts-grid{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:14px;
  margin-bottom:20px;
}
@media(max-width:1050px){.charts-grid{grid-template-columns:1fr 1fr}}
@media(max-width:680px){.charts-grid{grid-template-columns:1fr}}
.chart-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:20px;
}
.chart-title{
  font-family:'Syne',sans-serif;font-size:13px;font-weight:700;
  margin-bottom:4px;
}
.chart-sub{font-size:11px;color:var(--text2);margin-bottom:16px}
.chart-canvas-wrap{position:relative;height:180px}

/* Category bars chart */
.cat-bars{}
.cat-row{margin-bottom:12px}
.cat-row:last-child{margin-bottom:0}
.cat-row-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
.cat-name{font-size:12px;font-weight:500}
.cat-pct{font-family:'Syne',sans-serif;font-size:13px;font-weight:700}
.bar-bg{background:var(--surface3);border-radius:100px;height:7px;overflow:hidden}
.bar-fill{height:100%;border-radius:100px;transition:width 1.4s cubic-bezier(.16,1,.3,1)}
.cat-row-meta{display:flex;gap:10px;margin-top:4px}
.cat-mini-stat{font-size:10px;color:var(--text2);display:flex;align-items:center;gap:3px}
.cat-mini-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}

/* Regressed callout strip */
.regressed-strip{
  background:var(--red2);border:1px solid rgba(239,68,68,.3);
  border-radius:var(--r);padding:14px 20px;
  display:flex;align-items:center;gap:14px;
  margin-bottom:20px;flex-wrap:wrap;
}
.regressed-strip .icon{font-size:20px;flex-shrink:0}
.regressed-strip strong{font-family:'Syne',sans-serif;font-size:14px;color:var(--red)}
.regressed-strip p{font-size:12px;color:var(--text2);margin-top:2px}
#regressedList{display:flex;gap:8px;flex-wrap:wrap;margin-left:auto}
.regressed-pill{
  padding:4px 10px;border-radius:100px;
  background:var(--red2);border:1px solid rgba(239,68,68,.35);
  font-size:11px;color:var(--red);cursor:pointer;
  transition:background .15s;
}
.regressed-pill:hover{background:rgba(239,68,68,.25)}

/* â”€â”€â”€ FILTERS â”€â”€â”€ */
.filters-section{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);padding:16px 20px;
  margin-bottom:14px;
}
.filters-row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-end}
.filter-group{display:flex;flex-direction:column;gap:4px}
.filter-label{font-size:10px;text-transform:uppercase;letter-spacing:.6px;color:var(--text2)}
.filter-select,.filter-input{
  padding:7px 11px;border-radius:var(--r2);
  border:1px solid var(--border2);
  background:var(--surface2);
  color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:12px;
  outline:none;transition:border-color .18s;
  min-width:130px;
}
.filter-select:focus,.filter-input:focus{border-color:var(--blue)}
.filter-input{min-width:200px}
.filter-chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{
  padding:6px 13px;border-radius:100px;
  border:1px solid var(--border2);
  background:var(--surface2);
  font-size:11px;color:var(--text2);
  cursor:pointer;transition:all .15s;
  white-space:nowrap;
}
.chip:hover{border-color:rgba(0,120,212,.5);color:var(--text)}
.chip.active{background:var(--blue);border-color:var(--blue);color:#fff}
.chip.chip-green.active{background:var(--green);border-color:var(--green);color:#fff}
.chip.chip-red.active{background:var(--red);border-color:var(--red);color:#fff}
.chip.chip-amber.active{background:var(--amber);border-color:var(--amber);color:var(--bg)}
.chip.chip-purple.active{background:var(--purple);border-color:var(--purple);color:#fff}
.filters-row2{display:flex;gap:12px;align-items:center;margin-top:10px;flex-wrap:wrap}
.filter-divider{width:1px;height:28px;background:var(--border);flex-shrink:0}

/* â”€â”€â”€ TABLE â”€â”€â”€ */
.table-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:10px;flex-wrap:wrap;gap:8px;
}
.table-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700}
.table-count{
  padding:4px 10px;border-radius:100px;
  background:var(--surface2);border:1px solid var(--border);
  font-size:11px;color:var(--text2);
}
.table-actions{display:flex;gap:8px}
.table-wrap{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);overflow:hidden;
}
.table-inner{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:12px}
thead{background:var(--surface2)}
th{
  padding:11px 14px;text-align:left;
  font-family:'Syne',sans-serif;font-size:10px;
  text-transform:uppercase;letter-spacing:.7px;
  color:var(--text2);font-weight:600;white-space:nowrap;
  border-bottom:1px solid var(--border);
  cursor:pointer;user-select:none;position:relative;
  transition:color .15s;
}
th:hover{color:var(--text)}
th.sort-asc::after{content:' â†‘';opacity:.8}
th.sort-desc::after{content:' â†“';opacity:.8}
th:not(.sort-asc):not(.sort-desc)::after{content:' â‡…';opacity:.3;font-size:10px}
td{
  padding:11px 14px;
  border-bottom:1px solid var(--border);
  vertical-align:middle;
}
tr:last-child td{border-bottom:none}
tbody tr:hover td{background:rgba(0,120,212,.06)}
[data-theme="light"] tbody tr:hover td{background:rgba(0,120,212,.04)}
.td-action{max-width:320px;line-height:1.4}
.rank-badge{
  display:inline-flex;align-items:center;justify-content:center;
  width:24px;height:24px;border-radius:6px;
  font-family:'Syne',sans-serif;font-size:11px;font-weight:700;
  background:var(--surface3);color:var(--text2);
}
.rank-badge.top-rank{background:var(--amber2);color:var(--amber)}
.status-badge{
  display:inline-flex;align-items:center;gap:5px;
  padding:3px 9px;border-radius:100px;font-size:11px;
  white-space:nowrap;
}
.s-completed{background:var(--green2);color:var(--green);border:1px solid rgba(16,185,129,.3)}
.s-address{background:var(--red2);color:var(--red);border:1px solid rgba(239,68,68,.3)}
.s-planned{background:var(--purple2);color:var(--purple);border:1px solid rgba(129,140,248,.3)}
.s-risk{background:var(--amber2);color:var(--amber);border:1px solid rgba(245,158,11,.3)}
.s-default{background:var(--surface3);color:var(--text2);border:1px solid var(--border)}
.status-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.sd-green{background:var(--green)}
.sd-red{background:var(--red)}
.sd-purple{background:var(--purple)}
.sd-amber{background:var(--amber)}
.sd-grey{background:var(--text3)}
.impact-val{
  font-family:'Syne',sans-serif;font-weight:700;font-size:13px;color:var(--blue2)
}
.pts-wrap{min-width:110px}
.pts-top{display:flex;justify-content:space-between;margin-bottom:3px}
.pts-text{font-size:11px;color:var(--text2)}
.pts-pct{font-size:10px;color:var(--text3)}
.mini-bar-bg{background:var(--surface3);border-radius:3px;height:4px;overflow:hidden}
.mini-bar-fill{height:100%;border-radius:3px}
.yn-yes{color:var(--green);font-weight:500}
.yn-no{color:var(--text3)}
.reg-yes{color:var(--red);font-weight:500}
.reg-no{color:var(--text3)}
.prod-tag{
  padding:2px 7px;border-radius:5px;
  background:var(--surface3);border:1px solid var(--border);
  font-size:10px;color:var(--text2);white-space:nowrap;
}
.no-rows td{
  text-align:center;padding:48px 20px;
  color:var(--text2);font-size:13px;
}
.table-footer{
  padding:10px 14px;background:var(--surface2);
  border-top:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;
  font-size:11px;color:var(--text2);flex-wrap:wrap;gap:6px;
}

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
#emptyState{
  text-align:center;padding:64px 32px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);
}
#emptyState .empty-icon{font-size:48px;margin-bottom:16px;display:block;opacity:.5}
#emptyState h3{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:8px}
#emptyState p{font-size:13px;color:var(--text2)}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
.toast{
  position:fixed;bottom:24px;right:24px;z-index:9999;
  background:var(--surface);border:1px solid var(--border2);
  border-radius:var(--r);padding:14px 18px;
  font-size:13px;box-shadow:0 20px 48px rgba(0,0,0,.5);
  transform:translateY(80px);opacity:0;
  transition:all .3s cubic-bezier(.16,1,.3,1);
  display:flex;align-items:center;gap:10px;
  max-width:320px;pointer-events:none;
}
.toast.show{transform:none;opacity:1}
.toast-icon{font-size:18px;flex-shrink:0}

/* â”€â”€â”€ LOADER â”€â”€â”€ */
.loader{
  display:inline-block;width:14px;height:14px;
  border:2px solid var(--border2);
  border-top-color:var(--blue);
  border-radius:50%;animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(max-width:800px){
  .score-hero{grid-template-columns:1fr}
  .hero-gauge-side{border-right:none;border-bottom:1px solid var(--border);flex-direction:row;padding:20px 24px;gap:20px}
  .hero-metrics{gap:16px}
  .hero-metric .val{font-size:20px}
  .kpi-grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
}

/* Fade-in rows */
@keyframes fadeRow{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
tbody tr{animation:fadeRow .18s ease both}
</style>
</head>
<body>
<div class="page">

<!-- â•â•â• TOP NAV â•â•â• -->
<nav class="topnav">
  <div class="nav-brand">
    <div class="ms-logo"><span></span><span></span><span></span><span></span></div>
    <div>
      <div class="nav-title font-display">Microsoft Secure Score Dashboard</div>
      <div class="nav-sub">All tenants Â· Microsoft Defender</div>
    </div>
  </div>
  <div class="nav-actions">
    <div class="sync-badge">
      <span class="sync-dot inactive" id="syncDot"></span>
      <span id="syncLabel">No data loaded</span>
    </div>
    <button class="btn" id="exportBtn" disabled>â¬‡ Export CSV</button>
    <button class="btn" id="themeBtn">â˜€ Light</button>
  </div>
</nav>

<!-- â•â•â• UPLOAD ZONE â•â•â• -->
<div id="uploadZone">
  <input type="file" id="fileInput" accept=".csv,.xlsx,.xls"/>
  <span class="upload-icon">ğŸ“‚</span>
  <div class="upload-title font-display">Drop your Secure Score export here</div>
  <div class="upload-sub">Drag & drop or click to browse â€” all data stays in your browser, nothing is uploaded to any server.</div>
  <div class="upload-formats">
    <span class="fmt-badge">CSV</span>
    <span class="fmt-badge">Excel .xlsx</span>
    <span class="fmt-badge">Excel .xls</span>
  </div>
</div>

<!-- â•â•â• DASHBOARD (hidden until loaded) â•â•â• -->
<div id="dashboard">

  <!-- Score Hero -->
  <div class="score-hero">
    <svg style="width:0;height:0;position:absolute">
      <defs>
        <linearGradient id="heroGrad" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stop-color="#0078D4"/>
          <stop offset="100%" stop-color="#2899f5"/>
        </linearGradient>
      </defs>
    </svg>
    <div class="hero-gauge-side">
      <div class="gauge-wrap">
        <svg viewBox="0 0 160 160">
          <circle class="gauge-track" cx="80" cy="80" r="70"/>
          <circle class="gauge-fill" id="gaugeFill" cx="80" cy="80" r="70"/>
        </svg>
        <div class="gauge-center">
          <div class="gauge-pct font-display" id="gaugeNum">0%</div>
          <div class="gauge-of">secure score</div>
        </div>
      </div>
      <div class="hero-posture-chip" id="postureChip">Loadingâ€¦</div>
    </div>
    <div class="hero-content">
      <div>
        <div class="hero-heading font-display" id="heroHeading">Your security posture is <span id="heroPostureWord">â€”</span></div>
        <div class="hero-body" id="heroBody" style="margin-top:8px">Upload your Secure Score export to see your full posture analysis.</div>
      </div>
      <div class="hero-metrics" id="heroMetrics"></div>
    </div>
  </div>

  <!-- KPI Row -->
  <div class="kpi-grid" id="kpiGrid"></div>

  <!-- Charts -->
  <div class="charts-grid">
    <div class="chart-card">
      <div class="chart-title font-display">Score by Category</div>
      <div class="chart-sub">Points achieved vs. total available</div>
      <div class="cat-bars" id="catBars"></div>
    </div>
    <div class="chart-card">
      <div class="chart-title font-display">Actions by Status</div>
      <div class="chart-sub">Distribution of all recommendations</div>
      <div class="chart-canvas-wrap"><canvas id="statusChart"></canvas></div>
    </div>
    <div class="chart-card">
      <div class="chart-title font-display">Score Impact by Product</div>
      <div class="chart-sub">Top products with open improvements</div>
      <div class="chart-canvas-wrap"><canvas id="productChart"></canvas></div>
    </div>
  </div>

  <!-- Regressed strip (shown if any) -->
  <div class="regressed-strip" id="regressedStrip" style="display:none">
    <span class="icon">â¬‡</span>
    <div>
      <strong id="regressedCount">0 Regressed Items</strong>
      <p>Controls that previously met the standard but have since declined. Click to filter.</p>
    </div>
    <div id="regressedList"></div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="filters-row">
      <div class="filter-group">
        <span class="filter-label">Search</span>
        <input class="filter-input" id="searchInput" placeholder="Search action, product, categoryâ€¦"/>
      </div>
      <div class="filter-group">
        <span class="filter-label">Status</span>
        <div class="filter-chips" id="statusChips"></div>
      </div>
      <div class="filter-group">
        <span class="filter-label">Category</span>
        <select class="filter-select" id="catSelect"><option value="">All categories</option></select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Product</span>
        <select class="filter-select" id="prodSelect"><option value="">All products</option></select>
      </div>
      <div class="filter-group">
        <span class="filter-label">License</span>
        <div class="filter-chips">
          <span class="chip" data-lic="">All</span>
          <span class="chip chip-green" data-lic="Yes">Licensed</span>
          <span class="chip chip-red" data-lic="No">No license</span>
        </div>
      </div>
    </div>
    <div class="filters-row2">
      <div class="filter-group">
        <span class="filter-label">Regressed only</span>
        <div class="filter-chips">
          <span class="chip active" data-reg="">All</span>
          <span class="chip chip-red" data-reg="Yes">Regressed â¬‡</span>
        </div>
      </div>
      <div class="filter-divider"></div>
      <button class="btn" id="clearFilters">âœ• Clear all filters</button>
    </div>
  </div>

  <!-- Table -->
  <div class="table-header">
    <span class="table-title font-display">Recommendation Details</span>
    <span class="table-count" id="tableCount">Loadingâ€¦</span>
    <div class="table-actions">
      <button class="btn" id="copyTableBtn">â˜ Copy</button>
    </div>
  </div>

  <div class="table-wrap">
    <div class="table-inner">
      <table id="mainTable">
        <thead>
          <tr>
            <th data-col="Rank">#</th>
            <th data-col="Recommended action">Recommended Action</th>
            <th data-col="Score impact">Impact</th>
            <th data-col="Points achieved">Points</th>
            <th data-col="Status">Status</th>
            <th data-col="Regressed">Regressed</th>
            <th data-col="Have license?">License</th>
            <th data-col="Category">Category</th>
            <th data-col="Product">Product</th>
            <th data-col="Last synced">Last Synced</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div class="table-footer">
      <span id="tableFooterLeft">Upload a file to see recommendations.</span>
      <span>Click column headers to sort</span>
    </div>
  </div>

</div><!-- /dashboard -->

<!-- Empty-state (shows inside table when no filter match) -->
<div id="emptyState" style="display:none">
  <span class="empty-icon">ğŸ”</span>
  <h3 class="font-display">No matching recommendations</h3>
  <p>Try adjusting your filters or search query.</p>
</div>

</div><!-- /page -->

<!-- Toast -->
<div class="toast" id="toast">
  <span class="toast-icon" id="toastIcon"></span>
  <span id="toastMsg"></span>
</div>

<!-- Libraries (CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GLOBALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let rawData = [];
let filteredData = [];
let sortState = { col: 'Rank', dir: 'asc' };
let statusChart = null;
let productChart = null;

const COLS = ['Rank','Recommended action','Score impact','Points achieved','Status','Regressed','Have license?','Category','Product','Last synced'];

/* Filter state */
let fSearch = '';
let fStatus = '';
let fCat = '';
let fProd = '';
let fLic = '';
let fReg = '';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const themeBtn = document.getElementById('themeBtn');
let theme = localStorage.getItem('ssTheme') || 'dark';
function applyTheme(t){
  theme = t;
  document.documentElement.setAttribute('data-theme', t);
  themeBtn.textContent = t === 'dark' ? 'â˜€ Light' : 'ğŸŒ™ Dark';
  localStorage.setItem('ssTheme', t);
  if(statusChart) updateCharts(filteredData);
}
applyTheme(theme);
themeBtn.addEventListener('click', () => applyTheme(theme === 'dark' ? 'light' : 'dark'));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer;
function showToast(msg, icon='âœ…'){
  const t = document.getElementById('toast');
  document.getElementById('toastMsg').textContent = msg;
  document.getElementById('toastIcon').textContent = icon;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>t.classList.remove('show'), 3200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILE UPLOAD â€” DRAG & DROP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const zone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');

zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('drag-over'); });
zone.addEventListener('dragleave', () => zone.classList.remove('drag-over'));
zone.addEventListener('drop', e => {
  e.preventDefault(); zone.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if(file) handleFile(file);
});
fileInput.addEventListener('change', () => {
  if(fileInput.files[0]) handleFile(fileInput.files[0]);
});

function handleFile(file){
  const ext = file.name.split('.').pop().toLowerCase();
  if(ext === 'csv'){
    Papa.parse(file, {
      header:true, skipEmptyLines:true,
      complete: res => {
        const norm = normalizeHeaders(res.data);
        loadData(norm, file.name);
      },
      error: err => showToast('CSV parse error: ' + err.message, 'âŒ')
    });
  } else if(ext === 'xlsx' || ext === 'xls'){
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type:'binary' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
        const norm = normalizeHeaders(json);
        loadData(norm, file.name);
      } catch(err){ showToast('Excel parse error: ' + err.message, 'âŒ'); }
    };
    reader.readAsBinaryString(file);
  } else {
    showToast('Unsupported file format. Please use CSV or Excel.', 'âŒ');
  }
}

function normalizeHeaders(rows){
  return rows.map(row => {
    const clean = {};
    Object.keys(row).forEach(k => {
      const nk = k.trim().replace(/\uFEFF/g,'').replace(/\s+/g,' ');
      clean[nk] = row[k];
    });
    return clean;
  }).filter(r => r['Rank'] || r['Recommended action']);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOAD DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadData(rows, filename){
  rawData = rows;
  // reset filters
  fSearch=''; fStatus=''; fCat=''; fProd=''; fLic=''; fReg='';
  document.getElementById('searchInput').value = '';
  sortState = { col:'Rank', dir:'asc' };

  // show upload loaded state
  showUploadLoaded(filename, rows.length);
  buildFilterOptions();
  initStatusChips();
  applyFilters();
  document.getElementById('dashboard').classList.add('visible');
  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('exportBtn').disabled = false;
  document.getElementById('syncDot').classList.remove('inactive');
  document.getElementById('syncLabel').textContent = detectSyncRange(rows);
  showToast(`Loaded ${rows.length} recommendations from ${filename}`, 'ğŸ“Š');
}

function showUploadLoaded(filename, count){
  zone.classList.add('has-data');
  zone.innerHTML = `
    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="position:absolute;inset:0;opacity:0;cursor:pointer;z-index:1"/>
    <div class="upload-loaded">
      <span class="upload-file-icon">ğŸ“„</span>
      <div>
        <div class="upload-file-name font-display">${filename}</div>
        <div class="upload-file-meta">${count} recommendations loaded &nbsp;Â·&nbsp; All data stays local in your browser</div>
      </div>
    </div>
    <span class="upload-cta">â¬† Upload different file</span>`;
  document.getElementById('fileInput').addEventListener('change', () => {
    const f = document.getElementById('fileInput').files[0];
    if(f) handleFile(f);
  });
}

function detectSyncRange(rows){
  const dates = rows.map(r => r['Last synced']).filter(Boolean).map(d => new Date(d)).filter(d => !isNaN(d));
  if(!dates.length) return 'Sync date unknown';
  const min = new Date(Math.min(...dates));
  const max = new Date(Math.max(...dates));
  if(min.toDateString() === max.toDateString()) return `Synced ${max.toLocaleDateString()}`;
  return `${min.toLocaleDateString()} â†’ ${max.toLocaleDateString()}`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function parseImpact(v){ return v ? parseFloat(v.toString().replace('%','').trim()) || 0 : 0; }
function parsePoints(v){
  if(!v) return {a:0,t:0};
  const p = v.toString().split('/');
  return { a: parseFloat(p[0])||0, t: parseFloat(p[1])||0 };
}
function statusClass(s){
  if(!s) return 's-default';
  s = s.toLowerCase();
  if(s === 'completed') return 's-completed';
  if(s.includes('address')) return 's-address';
  if(s === 'planned') return 's-planned';
  if(s.includes('risk')) return 's-risk';
  return 's-default';
}
function statusDotClass(s){
  if(!s) return 'sd-grey';
  s = s.toLowerCase();
  if(s === 'completed') return 'sd-green';
  if(s.includes('address')) return 'sd-red';
  if(s === 'planned') return 'sd-purple';
  if(s.includes('risk')) return 'sd-amber';
  return 'sd-grey';
}
function barColor(s){
  if(!s) return 'var(--text3)';
  s = s.toLowerCase();
  if(s === 'completed') return 'var(--green)';
  if(s.includes('address')) return 'var(--red)';
  if(s === 'planned') return 'var(--purple)';
  return 'var(--text3)';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTER OPTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildFilterOptions(){
  const cats = new Set(), prods = new Set();
  rawData.forEach(r => {
    if(r['Category']) cats.add(r['Category'].trim());
    if(r['Product']) prods.add(r['Product'].trim());
  });
  const catSel = document.getElementById('catSelect');
  catSel.innerHTML = '<option value="">All categories</option>';
  [...cats].sort().forEach(c => { const o=document.createElement('option');o.value=c;o.textContent=c;catSel.appendChild(o); });

  const prodSel = document.getElementById('prodSelect');
  prodSel.innerHTML = '<option value="">All products</option>';
  [...prods].sort().forEach(p => { const o=document.createElement('option');o.value=p;o.textContent=p;prodSel.appendChild(o); });
}

/* Status chips */
function initStatusChips(){
  const statuses = [...new Set(rawData.map(r => (r['Status']||'').trim()).filter(Boolean))];
  const container = document.getElementById('statusChips');
  container.innerHTML = `<span class="chip active" data-s="">All</span>`;
  const colorMap = { 'Completed':'chip-green','To address':'chip-red','Planned':'chip-purple','Risk accepted':'chip-amber' };
  statuses.forEach(s => {
    const c = document.createElement('span');
    c.className = `chip ${colorMap[s]||''}`; c.dataset.s = s;
    c.textContent = s;
    container.appendChild(c);
  });
  container.querySelectorAll('.chip').forEach(chip => {
    chip.addEventListener('click', () => {
      container.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      chip.classList.add('active');
      fStatus = chip.dataset.s;
      applyFilters();
    });
  });
}

/* License chips */
document.querySelectorAll('[data-lic]').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('[data-lic]').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    fLic = chip.dataset.lic;
    applyFilters();
  });
});

/* Regressed chips */
document.querySelectorAll('[data-reg]').forEach(chip => {
  chip.addEventListener('click', () => {
    document.querySelectorAll('[data-reg]').forEach(c=>c.classList.remove('active'));
    chip.classList.add('active');
    fReg = chip.dataset.reg;
    applyFilters();
  });
});

document.getElementById('searchInput').addEventListener('input', e => { fSearch = e.target.value.toLowerCase(); applyFilters(); });
document.getElementById('catSelect').addEventListener('change', e => { fCat = e.target.value; applyFilters(); });
document.getElementById('prodSelect').addEventListener('change', e => { fProd = e.target.value; applyFilters(); });

document.getElementById('clearFilters').addEventListener('click', () => {
  fSearch=''; fStatus=''; fCat=''; fProd=''; fLic=''; fReg='';
  document.getElementById('searchInput').value='';
  document.getElementById('catSelect').value='';
  document.getElementById('prodSelect').value='';
  document.querySelectorAll('#statusChips .chip').forEach(c=>c.classList.remove('active'));
  document.querySelector('#statusChips .chip[data-s=""]').classList.add('active');
  document.querySelectorAll('[data-lic]').forEach(c=>c.classList.remove('active'));
  document.querySelector('[data-lic=""]').classList.add('active');
  document.querySelectorAll('[data-reg]').forEach(c=>c.classList.remove('active'));
  document.querySelector('[data-reg=""]').classList.add('active');
  applyFilters();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APPLY FILTERS + RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyFilters(){
  let d = rawData.filter(row => {
    const s = (row['Status']||'').trim();
    const cat = (row['Category']||'').trim();
    const prod = (row['Product']||'').trim();
    const lic = (row['Have license?']||'').trim();
    const reg = (row['Regressed']||'').trim();
    const text = Object.values(row).join(' ').toLowerCase();
    if(fSearch && !text.includes(fSearch)) return false;
    if(fStatus && s !== fStatus) return false;
    if(fCat && cat !== fCat) return false;
    if(fProd && prod !== fProd) return false;
    if(fLic && lic !== fLic) return false;
    if(fReg && reg !== fReg) return false;
    return true;
  });

  // sort
  d = d.sort((a,b) => compareRows(a,b));

  filteredData = d;
  renderTable(d);
  updateKPIs(d);
  updateCharts(d);
  updateRegressedStrip(d);

  const tc = document.getElementById('tableCount');
  tc.textContent = `${d.length} of ${rawData.length} actions`;
  document.getElementById('tableFooterLeft').textContent = `${d.length} rows Â· filtered from ${rawData.length} total`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SORTING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function compareRows(a,b){
  const col = sortState.col;
  const dir = sortState.dir === 'asc' ? 1 : -1;
  let av = a[col]||'', bv = b[col]||'';
  if(col === 'Rank') return dir*(parseFloat(av)-parseFloat(bv));
  if(col === 'Score impact') return dir*(parseImpact(av)-parseImpact(bv));
  if(col === 'Points achieved'){
    const pa = parsePoints(av), pb = parsePoints(bv);
    const ra = pa.t ? pa.a/pa.t : 0, rb = pb.t ? pb.a/pb.t : 0;
    return dir*(ra-rb);
  }
  if(col === 'Last synced') return dir*(new Date(av)-new Date(bv));
  return dir * av.toString().toLowerCase().localeCompare(bv.toString().toLowerCase());
}

document.querySelectorAll('th[data-col]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.col;
    if(sortState.col === col) sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
    else { sortState.col = col; sortState.dir = 'asc'; }
    document.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc','sort-desc'));
    th.classList.add(sortState.dir === 'asc' ? 'sort-asc' : 'sort-desc');
    applyFilters();
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTable(rows){
  const tbody = document.getElementById('tableBody');
  if(!rows.length){
    tbody.innerHTML = `<tr class="no-rows"><td colspan="${COLS.length}">No actions match the current filters.</td></tr>`;
    return;
  }
  tbody.innerHTML = rows.map((row,i) => {
    const rank = row['Rank']||'';
    const action = row['Recommended action']||'â€”';
    const impact = row['Score impact']||'';
    const pts = parsePoints(row['Points achieved']);
    const status = (row['Status']||'').trim();
    const reg = (row['Regressed']||'').trim();
    const lic = (row['Have license?']||'').trim();
    const cat = row['Category']||'';
    const prod = row['Product']||'';
    const synced = row['Last synced']||'';
    const pct = pts.t ? Math.round((pts.a/pts.t)*100) : 100;
    const bColor = barColor(status);
    const isTop = parseInt(rank) <= 3;

    return `<tr style="animation-delay:${Math.min(i*12,200)}ms">
      <td><span class="rank-badge${isTop?' top-rank':''}">${rank}</span></td>
      <td class="td-action">${escHtml(action)}</td>
      <td><span class="impact-val">${impact}</span></td>
      <td>
        <div class="pts-wrap">
          <div class="pts-top">
            <span class="pts-text">${pts.a}/${pts.t}</span>
            <span class="pts-pct">${pct}%</span>
          </div>
          <div class="mini-bar-bg"><div class="mini-bar-fill" style="width:${pct}%;background:${bColor}"></div></div>
        </div>
      </td>
      <td><span class="status-badge ${statusClass(status)}"><span class="status-dot ${statusDotClass(status)}"></span>${escHtml(status)}</span></td>
      <td><span class="${reg==='Yes'?'reg-yes':'reg-no'}">${reg==='Yes'?'â¬‡ Yes':'â€”'}</span></td>
      <td><span class="${lic==='Yes'?'yn-yes':'yn-no'}">${lic||'â€”'}</span></td>
      <td>${escHtml(cat)}</td>
      <td><span class="prod-tag">${escHtml(prod)}</span></td>
      <td>${synced}</td>
    </tr>`;
  }).join('');
}

function escHtml(s){ return s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UPDATE KPIs
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateKPIs(data){
  const total = data.length;
  const completed = data.filter(r=>(r['Status']||'').trim()==='Completed');
  const toAddress = data.filter(r=>(r['Status']||'').trim()==='To address');
  const planned   = data.filter(r=>(r['Status']||'').trim()==='Planned');
  const riskAcc   = data.filter(r=>(r['Status']||'').trim().toLowerCase().includes('risk'));
  const regressed = data.filter(r=>(r['Regressed']||'').trim()==='Yes');

  const achieved = data.reduce((s,r)=>s+parsePoints(r['Points achieved']).a,0);
  const possible = data.reduce((s,r)=>s+parsePoints(r['Points achieved']).t,0);
  const pct = possible ? Math.round((achieved/possible)*100) : 0;
  const potential = toAddress.reduce((s,r)=>{const p=parsePoints(r['Points achieved']);return s+(p.t-p.a);},0);

  // Animate gauge
  const circ = 2*Math.PI*70;
  const fill = document.getElementById('gaugeFill');
  fill.style.strokeDashoffset = circ - (pct/100)*circ;
  let n=0;
  const ivl = setInterval(()=>{
    n=Math.min(n+2,pct);
    document.getElementById('gaugeNum').textContent = n+'%';
    if(n>=pct) clearInterval(ivl);
  },16);

  // Posture
  let posture, postureClass, postureWord, bodyText;
  if(pct >= 80){ posture='Strong ğŸ’ª'; postureClass='posture-strong'; postureWord='Strong'; bodyText=`You have an excellent security posture. ${completed.length} of ${total} controls are complete. Focus attention on the ${toAddress.length} remaining open items.`; }
  else if(pct >= 55){ posture='Moderate âš '; postureClass='posture-moderate'; postureWord='Moderate'; bodyText=`Your posture is reasonable but ${toAddress.length} high-impact controls remain unresolved. Addressing the top-ranked actions could recover up to ${potential.toFixed(0)} additional points.`; }
  else { posture='At Risk ğŸ”´'; postureClass='posture-risk'; postureWord='At Risk'; bodyText=`Critical controls are missing. Immediate action on the top priority recommendations is required. Potential score gain: +${potential.toFixed(0)} points.`; }

  document.getElementById('postureChip').textContent = posture;
  document.getElementById('postureChip').className = `hero-posture-chip ${postureClass}`;
  document.getElementById('heroPostureWord').textContent = postureWord;
  document.getElementById('heroBody').textContent = bodyText;

  document.getElementById('heroMetrics').innerHTML = [
    {val: `${Math.round(achieved)}/${Math.round(possible)}`, lbl:'Points Achieved'},
    {val: completed.length, lbl:'Completed'},
    {val: toAddress.length, lbl:'To Address'},
    {val: `+${potential.toFixed(0)}`, lbl:'Pts Available'},
  ].map(m=>`<div class="hero-metric"><div class="val font-display">${m.val}</div><div class="lbl">${m.lbl}</div></div>`).join('');

  // KPI cards
  const kpis = [
    {emoji:'ğŸ¯', val:`${pct}%`, lbl:'Secure Score', note:`${Math.round(achieved)} of ${Math.round(possible)} pts`, bar:'linear-gradient(90deg,var(--blue),var(--blue2))'},
    {emoji:'âœ…', val:completed.length, lbl:'Completed', note:`${Math.round(completed.reduce((s,r)=>s+parsePoints(r['Points achieved']).a,0))} points secured`, bar:'linear-gradient(90deg,var(--green),#34d399)'},
    {emoji:'ğŸ”¥', val:toAddress.length, lbl:'Actions Required', note:`~+${potential.toFixed(0)} pts available`, bar:'linear-gradient(90deg,var(--red),#f87171)'},
    {emoji:'ğŸ“‰', val:regressed.length, lbl:'Regressed', note:'Controls that declined', bar:'linear-gradient(90deg,var(--amber),#fcd34d)'},
    {emoji:'ğŸ“‹', val:planned.length, lbl:'Planned', note:'In progress', bar:'linear-gradient(90deg,var(--purple),#a5b4fc)'},
    {emoji:'ğŸš«', val:riskAcc.length, lbl:'Risk Accepted', note:'Business decision', bar:'linear-gradient(90deg,var(--slate),#94a3b8)'},
  ];
  document.getElementById('kpiGrid').innerHTML = kpis.map(k=>`
    <div class="kpi">
      <div class="kpi-top-bar" style="background:${k.bar}"></div>
      <span class="kpi-emoji">${k.emoji}</span>
      <div class="kpi-val font-display">${k.val}</div>
      <div class="kpi-lbl">${k.lbl}</div>
      <div class="kpi-note">${k.note}</div>
    </div>`).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REGRESSED STRIP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateRegressedStrip(data){
  const reg = data.filter(r=>(r['Regressed']||'').trim()==='Yes');
  const strip = document.getElementById('regressedStrip');
  if(!reg.length){ strip.style.display='none'; return; }
  strip.style.display='flex';
  document.getElementById('regressedCount').textContent = `${reg.length} Regressed Item${reg.length>1?'s':''}`;
  const list = document.getElementById('regressedList');
  list.innerHTML = reg.slice(0,4).map(r=>{
    const action = (r['Recommended action']||'').substring(0,40)+'â€¦';
    return `<span class="regressed-pill" title="${r['Recommended action']}">${action}</span>`;
  }).join('');
  list.querySelectorAll('.regressed-pill').forEach(p=>{
    p.addEventListener('click',()=>{
      // filter to regressed
      document.querySelectorAll('[data-reg]').forEach(c=>c.classList.remove('active'));
      document.querySelector('[data-reg="Yes"]').classList.add('active');
      fReg='Yes'; applyFilters();
    });
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CHART_COLORS = ['#0078D4','#10b981','#f59e0b','#818cf8','#ef4444','#06b6d4','#ec4899'];
function getChartDefaults(){
  const isDark = theme === 'dark';
  return {
    textColor: isDark ? '#94a3b8' : '#475569',
    gridColor: isDark ? 'rgba(255,255,255,0.07)' : 'rgba(0,0,0,0.07)',
    bg: isDark ? '#0d1625' : '#ffffff',
  };
}

function updateCharts(data){
  updateCatBars(data);
  buildStatusChart(data);
  buildProductChart(data);
}

function updateCatBars(data){
  const cats = {};
  data.forEach(r=>{
    const c = (r['Category']||'Uncategorized').trim();
    const s = (r['Status']||'').trim();
    if(!cats[c]) cats[c]={achieved:0,total:0,completed:0,open:0};
    const p = parsePoints(r['Points achieved']);
    cats[c].achieved += p.a; cats[c].total += p.t;
    if(s==='Completed') cats[c].completed++;
    if(s==='To address') cats[c].open++;
  });
  const colors = {Identity:'var(--blue)',Apps:'var(--green)',Data:'var(--purple)',Device:'var(--amber)'};
  document.getElementById('catBars').innerHTML = Object.entries(cats).map(([name,c])=>{
    const pct = c.total ? Math.round((c.achieved/c.total)*100) : 100;
    const col = colors[name] || 'var(--blue2)';
    return `<div class="cat-row">
      <div class="cat-row-top">
        <span class="cat-name">${name}</span>
        <span class="cat-pct font-display" style="color:${col}">${pct}%</span>
      </div>
      <div class="bar-bg"><div class="bar-fill" style="background:${col};width:0%" data-w="${pct}%"></div></div>
      <div class="cat-row-meta">
        <span class="cat-mini-stat"><span class="cat-mini-dot" style="background:var(--green)"></span>${c.completed} done</span>
        <span class="cat-mini-stat"><span class="cat-mini-dot" style="background:var(--red)"></span>${c.open} open</span>
        <span class="cat-mini-stat">${Math.round(c.achieved)}/${Math.round(c.total)} pts</span>
      </div>
    </div>`;
  }).join('');
  setTimeout(()=>{
    document.querySelectorAll('.bar-fill').forEach(b=>b.style.width=b.dataset.w);
  },100);
}

function buildStatusChart(data){
  const counts = {};
  data.forEach(r=>{ const s=(r['Status']||'Unknown').trim(); counts[s]=(counts[s]||0)+1; });
  const labels=Object.keys(counts), values=labels.map(l=>counts[l]);
  const colorMap={'Completed':'#10b981','To address':'#ef4444','Planned':'#818cf8','Risk accepted':'#f59e0b'};
  const colors = labels.map(l=>colorMap[l]||'#64748b');
  const defaults = getChartDefaults();
  const ctx = document.getElementById('statusChart').getContext('2d');
  if(statusChart){ statusChart.destroy(); }
  statusChart = new Chart(ctx,{
    type:'doughnut',
    data:{labels,datasets:[{data:values,backgroundColor:colors,borderColor:'transparent',borderWidth:0,hoverOffset:6}]},
    options:{
      cutout:'65%',
      plugins:{
        legend:{ position:'bottom', labels:{color:defaults.textColor,font:{family:"'DM Sans',sans-serif",size:11},padding:12,boxWidth:10,boxHeight:10} },
        tooltip:{ backgroundColor:'#0d1625', titleColor:'#e2e8f4', bodyColor:'#94a3b8', borderColor:'rgba(255,255,255,.1)', borderWidth:1 }
      },
      animation:{ animateRotate:true, duration:900 }
    }
  });
}

function buildProductChart(data){
  // top products with open score gap
  const prods = {};
  data.filter(r=>(r['Status']||'').trim()==='To address').forEach(r=>{
    const p=(r['Product']||'Unknown').trim();
    const pts=parsePoints(r['Points achieved']);
    prods[p]=(prods[p]||0)+(pts.t-pts.a);
  });
  const sorted = Object.entries(prods).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const labels = sorted.map(e=>e[0]);
  const values = sorted.map(e=>parseFloat(e[1].toFixed(1)));
  const defaults = getChartDefaults();
  const ctx = document.getElementById('productChart').getContext('2d');
  if(productChart){ productChart.destroy(); }
  productChart = new Chart(ctx,{
    type:'bar',
    data:{
      labels,
      datasets:[{
        data:values,
        backgroundColor:CHART_COLORS.slice(0,labels.length),
        borderRadius:5,borderSkipped:false,
      }]
    },
    options:{
      indexAxis:'y',
      scales:{
        x:{ grid:{color:defaults.gridColor}, ticks:{color:defaults.textColor,font:{size:10}}, border:{display:false} },
        y:{ grid:{display:false}, ticks:{color:defaults.textColor,font:{size:10,family:"'DM Sans',sans-serif"}}, border:{display:false} }
      },
      plugins:{
        legend:{display:false},
        tooltip:{ backgroundColor:'#0d1625', titleColor:'#e2e8f4', bodyColor:'#94a3b8', borderColor:'rgba(255,255,255,.1)', borderWidth:1 }
      },
      animation:{duration:900}
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EXPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('exportBtn').addEventListener('click',()=>{
  if(!filteredData.length) return;
  const lines=[COLS.join(',')];
  filteredData.forEach(r=>{
    lines.push(COLS.map(k=>`"${(r[k]||'').toString().replace(/"/g,'""')}"`).join(','));
  });
  const blob = new Blob([lines.join('\r\n')],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href=url; a.download='secure-score-export.csv';
  document.body.appendChild(a); a.click();
  document.body.removeChild(a); URL.revokeObjectURL(url);
  showToast(`Exported ${filteredData.length} rows to CSV`, 'â¬‡');
});

/* Copy table */
document.getElementById('copyTableBtn').addEventListener('click',()=>{
  if(!filteredData.length) return;
  const header = COLS.join('\t');
  const rows = filteredData.map(r=>COLS.map(k=>r[k]||'').join('\t'));
  navigator.clipboard.writeText([header,...rows].join('\n'))
    .then(()=>showToast('Table copied to clipboard','â˜'))
    .catch(()=>showToast('Copy failed â€” try exporting CSV instead','âŒ'));
});

</script>
</body>
</html>